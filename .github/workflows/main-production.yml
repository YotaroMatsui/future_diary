name: Main CI + Production Deploy

on:
  push:
    branches:
      - main

concurrency:
  group: production-deploy
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ci:
    name: CI (lint/test/typecheck/build/smoke)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.45"

      - name: Install dependencies
        run: make install

      - name: Run CI
        run: make ci

      - name: Run smoke test
        run: make smoke

  deploy-api:
    name: Deploy API Worker (production)
    runs-on: ubuntu-latest
    needs:
      - ci
    timeout-minutes: 20
    environment:
      name: production
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.45"

      - name: Validate deploy configuration
        run: |
          test -n "${CLOUDFLARE_ACCOUNT_ID}" || (echo "::error::Missing secret CLOUDFLARE_ACCOUNT_ID" && exit 1)
          test -n "${CLOUDFLARE_API_TOKEN}" || (echo "::error::Missing secret CLOUDFLARE_API_TOKEN" && exit 1)

      - name: Install dependencies
        run: make install

      - name: Deploy API worker
        run: bunx wrangler deploy --config apps/api/wrangler.toml

  deploy-jobs:
    name: Deploy Jobs Worker (production)
    runs-on: ubuntu-latest
    needs:
      - ci
    timeout-minutes: 20
    environment:
      name: production
    env:
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.45"

      - name: Validate deploy configuration
        run: |
          test -n "${CLOUDFLARE_ACCOUNT_ID}" || (echo "::error::Missing secret CLOUDFLARE_ACCOUNT_ID" && exit 1)
          test -n "${CLOUDFLARE_API_TOKEN}" || (echo "::error::Missing secret CLOUDFLARE_API_TOKEN" && exit 1)

      - name: Install dependencies
        run: make install

      - name: Deploy Jobs worker
        run: bunx wrangler deploy --config apps/jobs/wrangler.toml

  deploy-web:
    name: Deploy Web (production)
    runs-on: ubuntu-latest
    needs:
      - ci
      - deploy-api
    timeout-minutes: 20
    environment:
      name: production
      url: https://future-diary-web.pages.dev
    env:
      PAGES_PROJECT_NAME: future-diary-web
      PAGES_PRODUCTION_BRANCH: main
      VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL_PRODUCTION }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.45"

      - name: Validate deploy configuration
        run: |
          test -n "${VITE_API_BASE_URL}" || (echo "::error::Missing repository variable VITE_API_BASE_URL_PRODUCTION" && exit 1)
          test -n "${CLOUDFLARE_ACCOUNT_ID}" || (echo "::error::Missing secret CLOUDFLARE_ACCOUNT_ID" && exit 1)
          test -n "${CLOUDFLARE_API_TOKEN}" || (echo "::error::Missing secret CLOUDFLARE_API_TOKEN" && exit 1)

      - name: Install dependencies
        run: make install

      - name: Build Web
        run: bun run --cwd apps/web build

      - name: Deploy to Cloudflare Pages production branch
        run: |
          bunx wrangler pages deploy apps/web/dist \
            --project-name "${PAGES_PROJECT_NAME}" \
            --branch "${PAGES_PRODUCTION_BRANCH}" \
            --commit-hash "${GITHUB_SHA}"

      - name: Job summary
        run: |
          echo "Production URL: https://future-diary-web.pages.dev" >> "${GITHUB_STEP_SUMMARY}"
